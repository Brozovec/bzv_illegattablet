Config2 = {}

Config2.dropOffLocationsshopshop = {
    boxLocations = {
        vec3(1531.9150, 6337.1035, 24.1404),   -- jsou to překopírovane lokace aby jich tam bylo víc a hodne random  :)
        vec3(1590.5112, 6462.2812, 25.3172),
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
        vec3(1531.9150, 6337.1035, 24.1404),
        vec3(1590.5112, 6462.2812, 25.3172),   
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
        vec3(1531.9150, 6337.1035, 24.1404),
        vec3(1590.5112, 6462.2812, 25.3172),
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
        vec3(1531.9150, 6337.1035, 24.1404),
        vec3(1590.5112, 6462.2812, 25.3172),
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
        vec3(1531.9150, 6337.1035, 24.1404),
        vec3(1590.5112, 6462.2812, 25.3172),
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
        vec3(1531.9150, 6337.1035, 24.1404),
        vec3(1590.5112, 6462.2812, 25.3172),
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
        vec3(1531.9150, 6337.1035, 24.1404),
        vec3(1590.5112, 6462.2812, 25.3172),
        vec3(281.9038, 6790.6372, 15.6949),
        vec3(-126.2325, 6572.2764, 29.5223),
        vec3(-269.1672, 6646.8965, 7.4339),
        vec3(-290.9773, 6160.1240, 31.4990),
        vec3(-2180.9087, 4269.8428, 49.1198),
        vec3(-1131.4595, 2704.6118, 18.8004),
        vec3(106.9480, 3738.5984, 39.8312),
        vec3(900.6871, 3580.5198, 33.3932),
        vec3(2545.4338, 2590.4734, 37.9555),
        vec3(1119.3480, -981.4224, 46.3913),
        vec3(-56.2399, -1322.8223, 29.2659),
        vec3(480.9245, -1873.5684, 26.4909),
        vec3(1374.8602, -2085.9409, 51.9985),
        vec3(1071.2898, -2324.7761, 30.3465),
    }
}

-- Hromadný nákup z NUI
RegisterNUICallback('purchaseItems', function(data, cb)
    if not data.items or #data.items == 0 then
        cb({ success = false, message = "Prázdný košík" })
        return
    end

    -- Odeslat data na server
    TriggerServerEvent('blackmarket:purchaseItems', data.items, data.totalPrice)
    cb({ success = true })
end)

-- Zavření NUI a info zpráva při objednání
RegisterNetEvent('blackmarket:closeNUI')
AddEventHandler('blackmarket:closeNUI', function()
    SetNuiFocus(false, false)
    SendNUIMessage({ action = 'hideUI' })

    lib.notify({
        title = 'Blackmarket',
        description = 'Objednávka přijata. Očekávejte zprávu během dne...',
        type = 'inform'
    })

    -- Po 5 minutách zpráva do lbphone
    SetTimeout(5 * 60 * 1000, function()                                  -- SetTimeout(5 * 60 * 1000, function()
        TriggerServerEvent('blackmarket:server:sendMessage', {
            message = "Vaše objednávka se zpracovává."
        })    end)
end)

-- Spuštění doručení – po 15 minutách
RegisterNetEvent('blackmarket:startDeliveryJob')
AddEventHandler('blackmarket:startDeliveryJob', function(deliveryData)
    -- Náhodná lokace pro zásilku
    local boxLoc = Config2.dropOffLocationsshopshop.boxLocations[math.random(1, #Config2.dropOffLocationsshopshop.boxLocations)]

    -- Po 15 minutách připravíme balík a notifikaci
    SetTimeout(15 * 60 * 1000, function()                       --SetTimeout(15 * 60 * 1000, function()
        Citizen.CreateThread(function()
            local modelHash = GetHashKey('hei_prop_heist_box')
            RequestModel(modelHash)
            while not HasModelLoaded(modelHash) do Citizen.Wait(10) end

            -- Pokud existuje starý prop, smaž ho
            if propObject then DeleteObject(propObject) end
            propObject = CreateObject(modelHash, boxLoc.x, boxLoc.y, boxLoc.z - 0.5, true, false, false)
            PlaceObjectOnGroundProperly(propObject)
            FreezeEntityPosition(propObject, true)

            -- Pokud máme data položek
            if deliveryData and deliveryData.items then
                print("Předávám položky:", json.encode(deliveryData.items))
            else
                print("Chyba: deliveryData nebo items nejsou správně")
            end

            -- Přidání interakční zóny pomocí ox_target
            zoneId = exports.ox_target:addBoxZone({
                coords = boxLoc,
                size = vector3(1.0, 1.0, 1.5),
                rotation = 0,
                debug = false,
                options = {
                    {
                        name = 'delivery_pickup',
                        event = 'bzv_bm:client:collectDelivery',
                        icon = 'fas fa-box',
                        label = 'Vyzvednout zásilku',
                        deliveryData = deliveryData
                    }
                }
            })

-- Správné volání serverové události pro odeslání zprávy
TriggerServerEvent('blackmarket:server:sendMessage', {
    message = string.format('Vaše zásilka je připravena k vyzvednutí na lokaci: [%f, %f]', boxLoc.x, boxLoc.y),
    coords = boxLoc
})
        end)
    end)
end)

-- Vyzvednutí zásilky
RegisterNetEvent('bzv_bm:client:collectDelivery')
AddEventHandler('bzv_bm:client:collectDelivery', function(data)
    if propObject then
        DeleteObject(propObject)
        propObject = nil

        -- Odebrání interakční zóny
        if zoneId then
            exports.ox_target:removeZone(zoneId)
        else
            print("Chyba: zoneId je nil")
        end

        -- Debug: Vytiskneme přijatá data
        print("Přijatá data z ox_target:", json.encode(data))
        
        if data and data.deliveryData then
            -- Debug: Vytiskneme deliveryData
            print("deliveryData z ox_target:", json.encode(data.deliveryData))
            
            local transformedItems = {}
            
            -- Opravená logika pro zpracování dat
            if data.deliveryData.items and #data.deliveryData.items > 0 then
                for _, item in ipairs(data.deliveryData.items) do
                    if item.itemId and item.quantity then
                        table.insert(transformedItems, {
                            name = item.itemId,  -- OPRAVA: Použití item.itemId jako name
                            count = item.quantity -- OPRAVA: Použití item.quantity jako count
                        })
                    end
                end
            end
            
            -- Debug: Vytiskneme transformovaná data
            print("Transformovaná data pro server:", json.encode(transformedItems))
            
            if #transformedItems > 0 then
                -- Použití ox_lib callbacku
                lib.callback('blackmarket:giveItems', false, function(success)
                    if success then
                        lib.notify({
                            title = 'Zásilka',
                            description = 'Zásilka byla úspěšně doručena!',
                            type = 'success'
                        })
                        
                        -- Zpráva o úspěšném doručení
                        TriggerServerEvent('blackmarket:server:sendMessage', {
                            message = "Zásilka úspěšně doručena, zboží bylo přidáno do tvého inventáře."
                        })
                    else
                        lib.notify({
                            title = 'Zásilka',
                            description = 'Něco se pokazilo při doručování zásilky!',
                            type = 'error'
                        })
                    end
                end, { items = transformedItems })
            else
                print("Chyba: Transformovaná data jsou prázdná!")
                lib.notify({
                    title = 'Zásilka',
                    description = 'Chyba: Žádné položky k předání!',
                    type = 'error'
                })
            end
        else
            print("Chyba: data nebo deliveryData nejsou platné")
            lib.notify({
                title = 'Zásilka',
                description = 'Chyba: Neplatná data zásilky!',
                type = 'error'
            })
        end
    end
end)
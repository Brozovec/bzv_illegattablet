----[[ GLOBAL VARIABLES ]]----
local inProximity = false
local propObject = nil
local activeTargets = {}
local deliveryTimer = nil
local deliveryTimeout = 600 -- sekundy (10 minut)

-- Lokace pro mise
local locations = {
    hackingLocations = {
        vec3(-109.6095, 6483.6118, 31.4684), -- jsou to překopírovane lokace aby jich tam bylo víc a hodne random  :)
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        vec3(-109.6095, 6483.6118, 31.4684),
        vec3(2905.1279, 4402.0176, 50.2330),
        vec3(1965.1602, 3750.1165, 32.2478),
        vec3(2046.8125, 2951.1218, 51.0222),
        vec3(2296.3330, 2944.1626, 46.5811),
        vec3(2853.8381, 1498.6260, 24.7244),
        vec3(2551.1865, 348.7336, 108.6207),
        vec3(1778.1963, -1621.1704, 112.4502),
        vec3(135.1666, -1046.6783, 29.1523),
        vec3(-1304.4194, -803.6601, 17.5808),
        vec3(258.4853, 274.7957, 105.6312),
        vec3(-343.7072, -79.4758, 45.6621),
        vec3(-360.5363, -1857.8848, 20.5444),
        vec3(-350.0362, -1569.9030, 25.2218),
        

    },
    dropOffLocations = {
        boxLocations = {
            vec3(1531.9150, 6337.1035, 24.1404),   -- jsou to překopírovane lokace aby jich tam bylo víc a hodne random  :)
            vec3(1590.5112, 6462.2812, 25.3172),
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            vec3(1531.9150, 6337.1035, 24.1404),
            vec3(1590.5112, 6462.2812, 25.3172),   
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            vec3(1531.9150, 6337.1035, 24.1404),
            vec3(1590.5112, 6462.2812, 25.3172),
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            vec3(1531.9150, 6337.1035, 24.1404),
            vec3(1590.5112, 6462.2812, 25.3172),
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            vec3(1531.9150, 6337.1035, 24.1404),
            vec3(1590.5112, 6462.2812, 25.3172),
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            vec3(1531.9150, 6337.1035, 24.1404),
            vec3(1590.5112, 6462.2812, 25.3172),
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            vec3(1531.9150, 6337.1035, 24.1404),
            vec3(1590.5112, 6462.2812, 25.3172),
            vec3(281.9038, 6790.6372, 15.6949),
            vec3(-126.2325, 6572.2764, 29.5223),
            vec3(-269.1672, 6646.8965, 7.4339),
            vec3(-290.9773, 6160.1240, 31.4990),
            vec3(-2180.9087, 4269.8428, 49.1198),
            vec3(-1131.4595, 2704.6118, 18.8004),
            vec3(106.9480, 3738.5984, 39.8312),
            vec3(900.6871, 3580.5198, 33.3932),
            vec3(2545.4338, 2590.4734, 37.9555),
            vec3(1119.3480, -981.4224, 46.3913),
            vec3(-56.2399, -1322.8223, 29.2659),
            vec3(480.9245, -1873.5684, 26.4909),
            vec3(1374.8602, -2085.9409, 51.9985),
            vec3(1071.2898, -2324.7761, 30.3465),
            


        },
        deliveryLocations = {
            vec3(1211.3922, -3251.3035, 7.0952),  -- jsou to překopírovane lokace aby jich tam bylo víc a hodne random  :)
            vec3(758.9294, -3154.9863, 5.9005),
            vec3(818.5402, -2960.2915, 6.0207),
            vec3(631.0418, -2959.4270, 6.0452),
            vec3(-524.6373, -2891.0903, 6.0004),
            vec3(-897.9123, -2393.6514, 14.0242),
            vec3(-74.0019, -2004.8282, 18.2753),
            vec3(-41.2230, -1747.6946, 29.3344),
            vec3(-197.3677, -831.2912, 30.7504),
            vec3(-1291.4640, -280.3205, 38.6642),
            vec3(-2284.7310, 353.4511, 174.6018),
            vec3(-3163.3347, 1115.8971, 20.8516),
            vec3(-296.0379, 2786.5037, 61.1225),
            vec3(180.1564, 2792.9819, 45.6552),
            vec3(429.3227, 2994.1169, 40.7410),
            vec3(347.1170, 3405.5930, 36.8517),
            vec3(2352.6216, 2523.2468, 47.6894),
            vec3(1700.0396, 3289.9714, 48.9219),
            vec3(2471.9153, 4110.5664, 38.0647),
            vec3(2889.5122, 4391.6289, 50.4512),
            vec3(2988.0654, 3481.6707, 72.4906),
            vec3(1332.5669, 4325.1362, 38.2535),
            vec3(1961.3090, 5185.1230, 47.9620),
            vec3(118.6881, 6625.9731, 31.9641),
            vec3(1211.3922, -3251.3035, 7.0952),
            vec3(758.9294, -3154.9863, 5.9005),
            vec3(818.5402, -2960.2915, 6.0207),
            vec3(631.0418, -2959.4270, 6.0452),
            vec3(-524.6373, -2891.0903, 6.0004),
            vec3(-897.9123, -2393.6514, 14.0242),
            vec3(-74.0019, -2004.8282, 18.2753),
            vec3(-41.2230, -1747.6946, 29.3344),
            vec3(-197.3677, -831.2912, 30.7504),
            vec3(-1291.4640, -280.3205, 38.6642),
            vec3(-2284.7310, 353.4511, 174.6018),
            vec3(-3163.3347, 1115.8971, 20.8516),
            vec3(-296.0379, 2786.5037, 61.1225),
            vec3(180.1564, 2792.9819, 45.6552),
            vec3(429.3227, 2994.1169, 40.7410),
            vec3(347.1170, 3405.5930, 36.8517),
            vec3(2352.6216, 2523.2468, 47.6894),
            vec3(1700.0396, 3289.9714, 48.9219),
            vec3(2471.9153, 4110.5664, 38.0647),
            vec3(2889.5122, 4391.6289, 50.4512),
            vec3(2988.0654, 3481.6707, 72.4906),
            vec3(1332.5669, 4325.1362, 38.2535),
            vec3(1961.3090, 5185.1230, 47.9620),
            vec3(118.6881, 6625.9731, 31.9641),
            vec3(1211.3922, -3251.3035, 7.0952),
            vec3(758.9294, -3154.9863, 5.9005),
            vec3(818.5402, -2960.2915, 6.0207),
            vec3(631.0418, -2959.4270, 6.0452),
            vec3(-524.6373, -2891.0903, 6.0004),
            vec3(-897.9123, -2393.6514, 14.0242),
            vec3(-74.0019, -2004.8282, 18.2753),
            vec3(-41.2230, -1747.6946, 29.3344),
            vec3(-197.3677, -831.2912, 30.7504),
            vec3(-1291.4640, -280.3205, 38.6642),
            vec3(-2284.7310, 353.4511, 174.6018),
            vec3(-3163.3347, 1115.8971, 20.8516),
            vec3(-296.0379, 2786.5037, 61.1225),
            vec3(180.1564, 2792.9819, 45.6552),
            vec3(429.3227, 2994.1169, 40.7410),
            vec3(347.1170, 3405.5930, 36.8517),
            vec3(2352.6216, 2523.2468, 47.6894),
            vec3(1700.0396, 3289.9714, 48.9219),
            vec3(2471.9153, 4110.5664, 38.0647),
            vec3(2889.5122, 4391.6289, 50.4512),
            vec3(2988.0654, 3481.6707, 72.4906),
            vec3(1332.5669, 4325.1362, 38.2535),
            vec3(1961.3090, 5185.1230, 47.9620),
            vec3(118.6881, 6625.9731, 31.9641),
            vec3(1211.3922, -3251.3035, 7.0952),
            vec3(758.9294, -3154.9863, 5.9005),
            vec3(818.5402, -2960.2915, 6.0207),
            vec3(631.0418, -2959.4270, 6.0452),
            vec3(-524.6373, -2891.0903, 6.0004),
            vec3(-897.9123, -2393.6514, 14.0242),
            vec3(-74.0019, -2004.8282, 18.2753),
            vec3(-41.2230, -1747.6946, 29.3344),
            vec3(-197.3677, -831.2912, 30.7504),
            vec3(-1291.4640, -280.3205, 38.6642),
            vec3(-2284.7310, 353.4511, 174.6018),
            vec3(-3163.3347, 1115.8971, 20.8516),
            vec3(-296.0379, 2786.5037, 61.1225),
            vec3(180.1564, 2792.9819, 45.6552),
            vec3(429.3227, 2994.1169, 40.7410),
            vec3(347.1170, 3405.5930, 36.8517),
            vec3(2352.6216, 2523.2468, 47.6894),
            vec3(1700.0396, 3289.9714, 48.9219),
            vec3(2471.9153, 4110.5664, 38.0647),
            vec3(2889.5122, 4391.6289, 50.4512),
            vec3(2988.0654, 3481.6707, 72.4906),
            vec3(1332.5669, 4325.1362, 38.2535),
            vec3(1961.3090, 5185.1230, 47.9620),
            vec3(118.6881, 6625.9731, 31.9641),
            vec3(1211.3922, -3251.3035, 7.0952),
            vec3(758.9294, -3154.9863, 5.9005),
            vec3(818.5402, -2960.2915, 6.0207),
            vec3(631.0418, -2959.4270, 6.0452),
            vec3(-524.6373, -2891.0903, 6.0004),
            vec3(-897.9123, -2393.6514, 14.0242),
            vec3(-74.0019, -2004.8282, 18.2753),
            vec3(-41.2230, -1747.6946, 29.3344),
            vec3(-197.3677, -831.2912, 30.7504),
            vec3(-1291.4640, -280.3205, 38.6642),
            vec3(-2284.7310, 353.4511, 174.6018),
            vec3(-3163.3347, 1115.8971, 20.8516),
            vec3(-296.0379, 2786.5037, 61.1225),
            vec3(180.1564, 2792.9819, 45.6552),
            vec3(429.3227, 2994.1169, 40.7410),
            vec3(347.1170, 3405.5930, 36.8517),
            vec3(2352.6216, 2523.2468, 47.6894),
            vec3(1700.0396, 3289.9714, 48.9219),
            vec3(2471.9153, 4110.5664, 38.0647),
            vec3(2889.5122, 4391.6289, 50.4512),
            vec3(2988.0654, 3481.6707, 72.4906),
            vec3(1332.5669, 4325.1362, 38.2535),
            vec3(1961.3090, 5185.1230, 47.9620),
            vec3(118.6881, 6625.9731, 31.9641),
            vec3(1211.3922, -3251.3035, 7.0952),
            vec3(758.9294, -3154.9863, 5.9005),
            vec3(818.5402, -2960.2915, 6.0207),
            vec3(631.0418, -2959.4270, 6.0452),
            vec3(-524.6373, -2891.0903, 6.0004),
            vec3(-897.9123, -2393.6514, 14.0242),
            vec3(-74.0019, -2004.8282, 18.2753),
            vec3(-41.2230, -1747.6946, 29.3344),
            vec3(-197.3677, -831.2912, 30.7504),
            vec3(-1291.4640, -280.3205, 38.6642),
            vec3(-2284.7310, 353.4511, 174.6018),
            vec3(-3163.3347, 1115.8971, 20.8516),
            vec3(-296.0379, 2786.5037, 61.1225),
            vec3(180.1564, 2792.9819, 45.6552),
            vec3(429.3227, 2994.1169, 40.7410),
            vec3(347.1170, 3405.5930, 36.8517),
            vec3(2352.6216, 2523.2468, 47.6894),
            vec3(1700.0396, 3289.9714, 48.9219),
            vec3(2471.9153, 4110.5664, 38.0647),
            vec3(2889.5122, 4391.6289, 50.4512),
            vec3(2988.0654, 3481.6707, 72.4906),
            vec3(1332.5669, 4325.1362, 38.2535),
            vec3(1961.3090, 5185.1230, 47.9620),
            vec3(118.6881, 6625.9731, 31.9641),
            
            
        }
    }
}

----[[ TARGET MANAGEMENT ]]----
local function removeZone(zoneId)
    local success = exports.ox_target:removeZone(zoneId)
    if success then activeTargets[zoneId] = nil end
end

local function registerTarget(zoneId, coords, options, size)
    if activeTargets[zoneId] then
        removeZone(zoneId)
    end

    exports.ox_target:addBoxZone({
        name = zoneId,
        coords = coords,
        size = size or vec3(1.5, 1.5, 2.0),
        options = options,
        debug = false
    })

    activeTargets[zoneId] = true
end

----[[ RANDOM JOB GENERATION ]]----
function getRandomJob()
    local jobTypes = {'drop_off',  'drop_off', 'hacking', 'drop_off', 'hacking', 'drop_off', 'hacking',}
    local randomJob = jobTypes[math.random(1, #jobTypes)]
    local args = {}

    if randomJob == 'drop_off' then
        args.boxLoc = locations.dropOffLocations.boxLocations[math.random(1, #locations.dropOffLocations.boxLocations)]
        args.dropLoc = locations.dropOffLocations.deliveryLocations[math.random(1, #locations.dropOffLocations.deliveryLocations)]
    elseif randomJob == 'hacking' then
        args.hackLoc = locations.hackingLocations[math.random(1, #locations.hackingLocations)]
    end

    return randomJob, args
end

----[[ HANDLING DROP OFF ]]----
function handleDropOff(args)
    local boxLoc = args.boxLoc
    local dropLoc = args.dropLoc

    TriggerServerEvent('blackmarket:server:sendMessage', {
        message = 'Tady je balíček, jdi ho vyzvednout. Další info pošleme hned jak ho vyzvedneš.',
        coords = boxLoc
    })

    Citizen.CreateThread(function()
        local modelHash = GetHashKey('hei_prop_heist_box')
        RequestModel(modelHash)
        while not HasModelLoaded(modelHash) do Citizen.Wait(10) end

        propObject = CreateObject(modelHash, boxLoc.x, boxLoc.y, boxLoc.z - 0.5, true, false, false)
        PlaceObjectOnGroundProperly(propObject)
        FreezeEntityPosition(propObject, true)
    end)

    registerTarget('pickup_zone', boxLoc, {
        {
            event = 'bzv_bm:client:pickUpBox',
            icon = 'fas fa-box',
            label = 'Vyzvedni balíček'
        }
    })
end

RegisterNetEvent('bzv_bm:client:pickUpBox')
AddEventHandler('bzv_bm:client:pickUpBox', function()
    if propObject then
        DeleteObject(propObject)
        ExecuteCommand('e pickup')
        propObject = nil
    end

    removeZone('pickup_zone')

    local dropLoc = locations.dropOffLocations.deliveryLocations[math.random(1, #locations.dropOffLocations.deliveryLocations)]
    nextStage(dropLoc)
end)

function nextStage(dropLoc)
    TriggerServerEvent('blackmarket:server:sendMessage', {
        message = 'Dovez ten balíček sem. Jestli ho nedovezeš, tak si tě najdeme.',
        coords = dropLoc
    })

    registerTarget('delivery_zone', dropLoc, {
        {
            event = 'bzv_bm:client:deliveryComplete',
            icon = 'fas fa-box',
            label = 'Položit balíček'
        }
    })

    if deliveryTimer then
        ClearTimeout(deliveryTimer)
    end

    deliveryTimer = SetTimeout(deliveryTimeout * 1000, function()
        removeZone('delivery_zone')
        TriggerServerEvent('blackmarket:server:sendMessage', {
            message = 'Zdržel ses moc dlouho. Mise zrušena.'
        })
    end)
end

RegisterNetEvent('bzv_bm:client:deliveryComplete')
AddEventHandler('bzv_bm:client:deliveryComplete', function()
    removeZone('delivery_zone')

    if deliveryTimer then
        ClearTimeout(deliveryTimer)
        deliveryTimer = nil
    end

    TriggerServerEvent('blackmarket:server:sendMessage', {
        message = 'Díky za dokončenou prácičku. Darkcoin ti převedeme.'
    })
    TriggerServerEvent('blackmarket:server:jobDone')
    TriggerServerEvent('blackmarket:completeJob', 'courier')
end)

----[[ HANDLING HACKING ]]----
function handleHacking(args)
    local hackLoc = args.hackLoc

    TriggerServerEvent('blackmarket:server:sendMessage', {
        message = 'Na tomhle místě najdeš terminál. Zkus ho hacknout.',
        coords = hackLoc
    })

    registerTarget('hacking_zone', hackLoc, {
        {
            event = 'bzv_bm:client:startHacking',
            icon = 'fas fa-laptop',
            label = 'Hacknout terminál'
        }
    })
end

RegisterNetEvent('bzv_bm:client:startHacking')
AddEventHandler('bzv_bm:client:startHacking', function()
    removeZone('hacking_zone')
    -- Start hacking minigame for hacking job
    SendNUIMessage({
        type = 'showHackingGame',
        hackType = 'bank',
        difficulty = 'hard'
    })
    SetNuiFocus(true, true)
end)

RegisterNUICallback('closeHackingGame', function(data, cb)
    -- Always remove focus first to ensure player can move again
    SetNuiFocus(false, false)

    -- Log the result for debugging
    print('Hack completed:', json.encode(data))

    if data.success then
        -- Handle successful hack based on type
        if data.hackType == 'traffic' then
            local dropLoc = locations.dropOffLocations.deliveryLocations[math.random(1, #locations.dropOffLocations.deliveryLocations)]
            nextStage(dropLoc)
        elseif data.hackType == 'bank' then
            TriggerServerEvent('blackmarket:server:sendMessage', {
                message = 'Hack úspěšný! Dostaneš odměnu.'
            })
            TriggerServerEvent('blackmarket:server:jobDone')
            TriggerServerEvent('blackmarket:completeJob', 'hack')
        end
    else
        TriggerServerEvent('blackmarket:server:sendMessage', {
            message = 'Posral jsi to! Už jsem jedou fízlové znova mě nekontaktuj kryso.'
        })
    end

    cb({})
end)



----[[ EVENT: START MISSION ]]----
RegisterNetEvent('bzv_bm:job:clientStartJob')
AddEventHandler('bzv_bm:job:clientStartJob', function(jobType, args)
    if not jobType then
        jobType, args = getRandomJob()
    end

    if jobType == 'drop_off' then
        handleDropOff(args)
    elseif jobType == 'hacking' then
        handleHacking(args)
    end
end)
